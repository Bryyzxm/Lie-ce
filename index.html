<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta
   name="viewport"
   content="width=device-width, initial-scale=1"
  />
  <title>Lie ce - Stock & Sales Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
   body {
    font-family: 'Inter', sans-serif;
   }
  </style>
 </head>
 <body class="bg-white text-black min-h-screen p-6 max-w-7xl mx-auto">
  <h1 class="text-4xl font-extrabold mb-8 tracking-tight">Lie ce - Stock & Sales Management</h1>

  <!-- Search and Filter -->
  <section class="mb-8">
   <input
    type="text"
    id="searchInput"
    placeholder="Search products by name or code..."
    class="w-full border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
   />
  </section>

  <!-- Product Management -->
  <section class="mb-12">
   <h2 class="text-2xl font-semibold mb-6 border-b border-gray-300 pb-2">Manage Products</h2>
   <form
    id="productForm"
    class="mb-6 grid grid-cols-1 sm:grid-cols-5 gap-4"
   >
    <input
     type="hidden"
     id="productId"
    />
    <input
     type="text"
     id="productName"
     placeholder="Product Name"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <input
     type="number"
     id="productStock"
     placeholder="Stock"
     min="0"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <input
     type="number"
     id="productPrice"
     placeholder="Price"
     min="0"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <input
     type="number"
     id="productCost"
     placeholder="Modal Price"
     min="0"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <button
     type="submit"
     class="bg-black text-white rounded px-6 py-3 hover:bg-gray-900 transition font-semibold"
    >
     Add
    </button>
   </form>
   <table class="w-full border-collapse border border-gray-300 shadow-sm">
    <thead>
     <tr class="bg-gray-100">
      <th class="border border-gray-300 p-3 text-left font-medium">Name</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Stock</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Price</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Modal Price</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Actions</th>
     </tr>
    </thead>
    <tbody id="productTableBody">
     <!-- Products will be rendered here -->
    </tbody>
   </table>
  </section>

  <!-- Sales Transaction -->
  <section class="mb-12">
   <h2 class="text-2xl font-semibold mb-6 border-b border-gray-300 pb-2">Record Sales Transaction</h2>
   <form
    id="transactionForm"
    class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6"
   >
    <input
     type="date"
     id="transactionDate"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <select
     id="transactionProduct"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    >
     <option value="">Select Product</option>
    </select>
    <input
     type="number"
     id="transactionQuantity"
     placeholder="Quantity"
     min="1"
     required
     class="border border-gray-400 p-3 rounded focus:outline-none focus:ring-2 focus:ring-black transition"
    />
    <button
     type="submit"
     class="bg-black text-white rounded px-6 py-3 hover:bg-gray-900 transition font-semibold"
    >
     Add Transaction
    </button>
   </form>
   <table class="w-full border-collapse border border-gray-300 shadow-sm">
    <thead>
     <tr class="bg-gray-100">
      <th class="border border-gray-300 p-3 text-left font-medium">Date</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Product</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Quantity</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Total</th>
     </tr>
    </thead>
    <tbody id="transactionTableBody">
     <!-- Transactions will be rendered here -->
    </tbody>
   </table>
  </section>

  <!-- Stock Overview -->
  <section class="mb-12">
   <h2 class="text-2xl font-semibold mb-6 border-b border-gray-300 pb-2">Stock Overview</h2>
   <table class="w-full border-collapse border border-gray-300 shadow-sm">
    <thead>
     <tr class="bg-gray-100">
      <th class="border border-gray-300 p-3 text-left font-medium">Product</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Stock Remaining</th>
      <th class="border border-gray-300 p-3 text-left font-medium">Status</th>
     </tr>
    </thead>
    <tbody id="stockTableBody">
     <!-- Stock will be rendered here -->
    </tbody>
   </table>
  </section>

  <!-- Sales Reports -->
  <section class="mb-12">
   <h2 class="text-2xl font-semibold mb-6 border-b border-gray-300 pb-2">Sales Reports</h2>
   <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
    <div class="p-6 border rounded-lg shadow-md bg-gray-50 flex flex-col items-center">
     <h3 class="text-lg font-semibold mb-3">Daily Sales</h3>
     <p
      id="dailySales"
      class="text-3xl font-extrabold"
     >
      Rp 0
     </p>
     <p
      id="dailyCount"
      class="text-sm text-gray-600 mt-1"
     >
      0 transactions
     </p>
    </div>
    <div class="p-6 border rounded-lg shadow-md bg-gray-50 flex flex-col items-center">
     <h3 class="text-lg font-semibold mb-3">Weekly Sales</h3>
     <p
      id="weeklySales"
      class="text-3xl font-extrabold"
     >
      Rp 0
     </p>
     <p
      id="weeklyCount"
      class="text-sm text-gray-600 mt-1"
     >
      0 transactions
     </p>
    </div>
    <div class="p-6 border rounded-lg shadow-md bg-gray-50 flex flex-col items-center">
     <h3 class="text-lg font-semibold mb-3">Monthly Sales</h3>
     <p
      id="monthlySales"
      class="text-3xl font-extrabold"
     >
      Rp 0
     </p>
     <p
      id="monthlyCount"
      class="text-sm text-gray-600 mt-1"
     >
      0 transactions
     </p>
    </div>
   </div>
  </section>

  <!-- Export Data -->
  <section class="mb-12">
   <button
    id="exportBtn"
    class="bg-black text-white rounded px-6 py-3 hover:bg-gray-900 transition font-semibold"
   >
    Export Sales Data to CSV
   </button>
  </section>

  <script>
   // Data storage keys
   const PRODUCTS_KEY = 'liece_products';
   const TRANSACTIONS_KEY = 'liece_transactions';

   // Elements
   const productForm = document.getElementById('productForm');
   const productIdInput = document.getElementById('productId');
   const productNameInput = document.getElementById('productName');
   const productStockInput = document.getElementById('productStock');
   const productPriceInput = document.getElementById('productPrice');
   const productCodeInput = document.getElementById('productCode');
   const productTableBody = document.getElementById('productTableBody');

   const transactionForm = document.getElementById('transactionForm');
   const transactionDateInput = document.getElementById('transactionDate');
   const transactionProductSelect = document.getElementById('transactionProduct');
   const transactionQuantityInput = document.getElementById('transactionQuantity');
   const transactionTableBody = document.getElementById('transactionTableBody');

   const stockTableBody = document.getElementById('stockTableBody');

   const dailySalesElem = document.getElementById('dailySales');
   const dailyCountElem = document.getElementById('dailyCount');
   const weeklySalesElem = document.getElementById('weeklySales');
   const weeklyCountElem = document.getElementById('weeklyCount');
   const monthlySalesElem = document.getElementById('monthlySales');
   const monthlyCountElem = document.getElementById('monthlyCount');

   const exportBtn = document.getElementById('exportBtn');

   // Data arrays
   let products = [];
   let transactions = [];

   // Load data from localStorage
   function loadData() {
    products = JSON.parse(localStorage.getItem(PRODUCTS_KEY)) || [];
    transactions = JSON.parse(localStorage.getItem(TRANSACTIONS_KEY)) || [];
   }

   // Save data to localStorage
   function saveData() {
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
    localStorage.setItem(TRANSACTIONS_KEY, JSON.stringify(transactions));
   }

   // Render products table
   function renderProducts(filter = '') {
    productTableBody.innerHTML = '';
    const filtered = products.filter((p) => p.name.toLowerCase().includes(filter.toLowerCase()));
    if (filtered.length === 0) {
     productTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-gray-500 italic">No products available.</td></tr>';
     return;
    }
    filtered.forEach((product) => {
     const tr = document.createElement('tr');
     tr.className = 'hover:bg-gray-50 transition';
     tr.innerHTML = `
          <td class="border border-gray-300 p-3">${product.name}</td>
          <td class="border border-gray-300 p-3">${product.stock}</td>
          <td class="border border-gray-300 p-3">${product.price.toLocaleString()}</td>
          <td class="border border-gray-300 p-3">${product.cost.toLocaleString()}</td>
          <td class="border border-gray-300 p-3 space-x-4">
            <button class="text-blue-600 hover:underline font-semibold edit-btn" data-id="${product.id}">Edit</button>
            <button class="text-red-600 hover:underline font-semibold delete-btn" data-id="${product.id}">Delete</button>
          </td>
        `;
     productTableBody.appendChild(tr);
    });
    attachProductTableEvents();
   }

   // Attach edit and delete button events in product table
   function attachProductTableEvents() {
    document.querySelectorAll('.edit-btn').forEach((btn) => {
     btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const product = products.find((p) => p.id === id);
      if (product) {
       productIdInput.value = product.id;
       productNameInput.value = product.name;
       productStockInput.value = product.stock;
       productPriceInput.value = product.price;
       productCostInput.value = product.cost;
       productForm.querySelector('button[type=submit]').textContent = 'Update';
      }
     });
    });
    document.querySelectorAll('.delete-btn').forEach((btn) => {
     btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      if (confirm('Are you sure you want to delete this product?')) {
       products = products.filter((p) => p.id !== id);
       saveData();
       renderProducts(document.getElementById('searchInput').value);
       renderStock();
       renderTransactionProductOptions();
      }
     });
    });
   }

   // Render transaction product options
   function renderTransactionProductOptions() {
    transactionProductSelect.innerHTML = '<option value="">Select Product</option>';
    products.forEach((product) => {
     transactionProductSelect.innerHTML += `<option value="${product.id}">${product.name} (Stock: ${product.stock})</option>`;
    });
   }

   // Render transactions table
   function renderTransactions() {
    transactionTableBody.innerHTML = '';
    if (transactions.length === 0) {
     transactionTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-6 text-gray-500 italic">No transactions recorded.</td></tr>';
     return;
    }
    transactions.forEach((tx) => {
     const product = products.find((p) => p.id === tx.productId);
     const tr = document.createElement('tr');
     tr.className = 'hover:bg-gray-50 transition';
     tr.innerHTML = `
          <td class="border border-gray-300 p-3">${tx.date}</td>
          <td class="border border-gray-300 p-3">${product ? product.name : 'Unknown'}</td>
          <td class="border border-gray-300 p-3">${tx.quantity}</td>
          <td class="border border-gray-300 p-3">${tx.total.toLocaleString()}</td>
        `;
     transactionTableBody.appendChild(tr);
    });
   }

   // Render stock overview table
   function renderStock() {
    stockTableBody.innerHTML = '';
    if (products.length === 0) {
     stockTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No products available.</td></tr>';
     return;
    }
    products.forEach((product) => {
     const isLowStock = product.stock < 3;
     const tr = document.createElement('tr');
     tr.className = 'hover:bg-gray-50 transition';
     tr.innerHTML = `
          <td class="border border-gray-300 p-3">${product.name}</td>
          <td class="border border-gray-300 p-3">${product.stock}</td>
          <td class="border border-gray-300 p-3 font-semibold ${isLowStock ? 'text-red-600' : 'text-green-600'}">${isLowStock ? 'Low Stock' : 'Sufficient'}</td>
        `;
     stockTableBody.appendChild(tr);
    });
   }

   // Calculate and render sales reports and profit
   function renderReports() {
    const now = new Date();

    // Helper to filter transactions by date range
    function filterByDateRange(start, end) {
     return transactions.filter((tx) => {
      const txDate = new Date(tx.date);
      return txDate >= start && txDate <= end;
     });
    }

    // Helper to sum totals and profits
    function sumTransactions(txList) {
     let total = 0;
     let profit = 0;
     txList.forEach((tx) => {
      total += tx.total;
      const product = products.find((p) => p.id === tx.productId);
      if (product) {
       // Profit = (selling price - modal price) * quantity
       profit += tx.quantity * (product.price - product.cost);
      }
     });
     return {total, profit};
    }

    // Daily
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const dailyTx = filterByDateRange(startOfDay, now);
    const dailyData = sumTransactions(dailyTx);

    // Weekly (last 7 days)
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - 6);
    const weeklyTx = filterByDateRange(startOfWeek, now);
    const weeklyData = sumTransactions(weeklyTx);

    // Monthly (current month)
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthlyTx = filterByDateRange(startOfMonth, now);
    const monthlyData = sumTransactions(monthlyTx);

    dailySalesElem.textContent = 'Rp ' + dailyData.total.toLocaleString();
    dailyCountElem.textContent = dailyTx.length + ' transactions | Profit: Rp ' + dailyData.profit.toLocaleString();
    weeklySalesElem.textContent = 'Rp ' + weeklyData.total.toLocaleString();
    weeklyCountElem.textContent = weeklyTx.length + ' transactions | Profit: Rp ' + weeklyData.profit.toLocaleString();
    monthlySalesElem.textContent = 'Rp ' + monthlyData.total.toLocaleString();
    monthlyCountElem.textContent = monthlyTx.length + ' transactions | Profit: Rp ' + monthlyData.profit.toLocaleString();
   }

   // Export transactions to CSV
   function exportToCSV() {
    if (transactions.length === 0) {
     alert('No transactions to export.');
     return;
    }
    const headers = ['ID', 'Date', 'Product ID', 'Quantity', 'Total'];
    const rows = transactions.map((tx) => [tx.id, tx.date, tx.productId, tx.quantity, tx.total]);
    let csvContent = headers.join(',') + '\\n';
    rows.forEach((row) => {
     csvContent += row.join(',') + '\\n';
    });
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'sales_data.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
   }

   // Generate unique ID
   function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
   }

   // Event listeners
   productForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const id = productIdInput.value;
    const name = productNameInput.value.trim();
    const stock = parseInt(productStockInput.value);
    const price = parseFloat(productPriceInput.value);
    const cost = parseFloat(productCost.value);

    if (!name || isNaN(stock) || isNaN(price) || isNaN(cost)) {
     alert('Please fill all product fields correctly.');
     return;
    }

    if (id) {
     // Update existing product
     const index = products.findIndex((p) => p.id === id);
     if (index !== -1) {
      products[index] = {id, name, stock, price, cost};
     }
    } else {
     // Add new product
     products.push({id: generateId(), name, stock, price, cost});
    }

    saveData();
    renderProducts(document.getElementById('searchInput').value);
    renderStock();
    renderTransactionProductOptions();

    productForm.reset();
    productIdInput.value = '';
    productForm.querySelector('button[type=submit]').textContent = 'Add';
   });

   transactionForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const date = transactionDateInput.value;
    const productId = transactionProductSelect.value;
    const quantity = parseInt(transactionQuantityInput.value);

    if (!date || !productId || isNaN(quantity) || quantity <= 0) {
     alert('Please fill all transaction fields correctly.');
     return;
    }

    const product = products.find((p) => p.id === productId);
    if (!product) {
     alert('Selected product not found.');
     return;
    }

    if (quantity > product.stock) {
     alert('Insufficient stock.');
     return;
    }

    const total = quantity * product.price;
    const id = generateId();

    transactions.push({id, date, productId, quantity, total});

    // Update product stock
    product.stock -= quantity;

    saveData();
    renderProducts(document.getElementById('searchInput').value);
    renderStock();
    renderTransactionProductOptions();
    renderTransactions();
    renderReports();

    transactionForm.reset();
   });

   exportBtn.addEventListener('click', exportToCSV);

   document.getElementById('searchInput').addEventListener('input', (e) => {
    renderProducts(e.target.value);
   });

   // Initialize
   function init() {
    loadData();
    renderProducts();
    renderTransactionProductOptions();
    renderTransactions();
    renderStock();
    renderReports();
    transactionDateInput.valueAsDate = new Date();
   }

   init();
  </script>
 </body>
</html>
